<!DOCTYPE html>
<html>

<head>
    <title>Stream of Consciousness</title>
    <style>
        body {
            font-family: 'Helvetica Neue', Helvetica, sans-serif;
            font-weight: 100;
            margin: 0;
            padding: 0;
        }
        #startPage {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            width: 100%;
            height: 100vh;
            background: white;
            z-index: 1000;
        }
        #startPage.hidden {
            display: none;
        }
        .difficulty-title {
            font-size: 24px;
            margin-bottom: 40px;
            color: black;
        }
        .difficulty-circles {
            display: flex;
            gap: 50px;
        }
        .difficulty-circle {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: 1px solid black;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 16px;
            font-weight: 100;
            cursor: pointer;
            opacity: 1;
            transition: opacity 0.3s ease;
        }
        .difficulty-circle:hover {
            opacity: 0.5;
        }
        .dotpage {
            display: none;
            width: 100%;
            height: 100vh;
            background: white;
        }
        .dotpage.active {
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .dotpage canvas {
            border: 1px solid #ccc;
        }
        #nameInputPage {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            width: 100%;
            height: 100vh;
            background: white;
            z-index: 1000;
        }
        #nameInputPage.hidden {
            display: none;
        }
        .name-label {
            font-size: 24px;
            margin-bottom: 40px;
            color: black;
            cursor: pointer;
        }
        .name-label:hover {
            opacity: 0.5;
        }
        #nameInput {
            font-family: 'Helvetica Neue', Helvetica, sans-serif;
            font-weight: 100;
            font-size: 24px;
            padding: 10px 15px;
            border: 1px solid black;
            margin-bottom: 20px;
            display: block;
            text-align: center;
        }
        #nameInput.show {
            display: block;
        }
        #submitBtn.show {
            display: block;
        }
        #drawingPage, #drawingPage2, #drawingPage3 {
            display: none;
            width: 100%;
            height: 100vh;
            background: white;
            flex-direction: column;
            align-items: center;
        }
        #drawingPage.active, #drawingPage2.active, #drawingPage3.active {
            display: flex;
        }
        .drawing-prompt {
            margin-top: 25vh;
            font-size: 24px;
            margin-bottom: 40px;
            color: black;
        }
        #drawingCanvas, #drawingCanvas2, #drawingCanvas3 {
            border: 1px solid black;
            cursor: crosshair;
        }
        .save-button {
            margin-top: 30px;
            font-family: 'Helvetica Neue', Helvetica, sans-serif;
            font-weight: 100;
            font-size: 16px;
            padding: 8px 20px;
            border: 1px solid black;
            background: white;
            cursor: pointer;
        }
        .library-button {
            margin-top: 40px;
            font-family: 'Helvetica Neue', Helvetica, sans-serif;
            font-weight: 100;
            font-size: 16px;
            padding: 8px 20px;
            border: 1px solid black;
            background: white;
            cursor: pointer;
        }
        #libraryPage {
            width: 100%;
            height: 100vh;
            background: white;
            overflow-y: auto;
            padding: 40px 20px;
            box-sizing: border-box;
        }
        #libraryPage.hidden {
            display: none;
        }
        .back-button {
            position: fixed;
            top: 20px;
            left: 20px;
            font-family: 'Helvetica Neue', Helvetica, sans-serif;
            font-weight: 100;
            font-size: 14px;
            padding: 8px 16px;
            border: 1px solid black;
            background: white;
            cursor: pointer;
            z-index: 100;
        }
        .library-container {
            position: relative;
            width: 100%;
            height: 2000px;
        }
        .drawing-item {
            position: absolute;
            border: 2px solid black;
            background: #f0f0f0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .drawing-item img {
            display: block;
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        .drawing-info {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(255,255,255,0.9);
            padding: 4px 8px;
            font-family: 'Helvetica Neue', Helvetica, sans-serif;
            font-weight: 100;
            font-size: 12px;
            border-top: 1px solid black;
            text-align: center;
        }
    </style>
</head>

<body>
    <div id="nameInputPage">
        <input type="text" id="nameInput" placeholder="Enter your name">
        <button id="submitBtn" onclick="var name = document.getElementById('nameInput').value; if(name.trim() === '') { alert('Please enter a name'); } else { window.userName = name; window.loadUserDrawings(name); console.log('Set userName to:', window.userName); document.getElementById('nameInputPage').classList.add('hidden'); document.getElementById('startPage').classList.remove('hidden'); }">Submit</button>
    </div>
    <div id="startPage" class="hidden">
        <div class="difficulty-title">please select level of difficulty</div>
        <div class="difficulty-circles">
            <div class="difficulty-circle" data-level="1" onclick="document.getElementById('startPage').classList.add('hidden'); document.getElementById('drawingPage').classList.add('active'); setTimeout(function() { window.loadDrawingToCanvas(1); window.setupDrawing(); }, 100);">1</div>
            <div class="difficulty-circle" data-level="2" onclick="document.getElementById('startPage').classList.add('hidden'); document.getElementById('drawingPage2').classList.add('active'); setTimeout(function() { window.loadDrawingToCanvas(2); window.setupDrawing2(); }, 100);">2</div>
            <div class="difficulty-circle" data-level="3" onclick="document.getElementById('startPage').classList.add('hidden'); document.getElementById('drawingPage3').classList.add('active'); setTimeout(function() { window.loadDrawingToCanvas(3); window.setupDrawing3(); }, 100);">3</div>
        </div>
        <button class="library-button" onclick="window.loadLibrary();">view drawing library</button>
    </div>
    <div id="libraryPage" class="hidden">
        <button class="back-button" onclick="document.getElementById('libraryPage').classList.add('hidden'); document.getElementById('startPage').classList.remove('hidden');">back</button>
        <div id="libraryContainer" class="library-container"></div>
    </div>
    <div id="dotpage1" class="dotpage"></div>
    <div id="dotpage2" class="dotpage"></div>
    <div id="dotpage3" class="dotpage"></div>
    <div id="drawingPage">
        <div class="drawing-prompt">please draw a cat</div>
        <canvas id="drawingCanvas" width="800" height="400" style="border: 2px solid black; display: block;"></canvas>
        <button class="save-button" onclick="window.saveDrawingToFirebase(1); document.getElementById('drawingPage').classList.remove('active'); document.getElementById('startPage').classList.remove('hidden');">Save</button>
    </div>
    <div id="drawingPage2">
        <div class="drawing-prompt">please draw a loved one</div>
        <canvas id="drawingCanvas2" width="800" height="400" style="border: 2px solid black; display: block;"></canvas>
        <button class="save-button" onclick="window.saveDrawingToFirebase(2); document.getElementById('drawingPage2').classList.remove('active'); document.getElementById('startPage').classList.remove('hidden');">Save</button>
    </div>
    <div id="drawingPage3">
        <div class="drawing-prompt">please draw a memory you wish to erase</div>
        <canvas id="drawingCanvas3" width="800" height="400" style="border: 2px solid black; display: block;"></canvas>
        <button class="save-button" onclick="const canvas3 = document.getElementById('drawingCanvas3'); const ctx3 = canvas3.getContext('2d'); ctx3.fillStyle = 'white'; ctx3.fillRect(0, 0, canvas3.width, canvas3.height); document.getElementById('drawingPage3').classList.remove('active'); document.getElementById('startPage').classList.remove('hidden');">Erase</button>
    </div>
    <script>
        // Initialize Firebase for inline use - MUST be before module script
        const firebaseConfig = {
          apiKey: "AIzaSyCx5bmSMOX5rzlyvK2l72OdnTO91kxoMOI",
          authDomain: "thi-huy.firebaseapp.com",
          databaseURL: "https://thi-huy-default-rtdb.firebaseio.com",
          projectId: "thi-huy",
          storageBucket: "thi-huy.firebasestorage.app",
          messagingSenderId: "10229453813",
          appId: "1:10229453813:web:24ad3a7a678b20d8b946bc",
          measurementId: "G-50RLFQRN1E"
        };

        // Store user name globally
        window.userName = null;
        window.userDrawings = {};  // Store fetched drawings
        
        // Simple function to set user name
        window.setUserName = function(name) {
            window.userName = name;
            console.log('User name set to:', window.userName);
        };

        // Fetch user's existing drawings from Firebase
        window.loadUserDrawings = function(name) {
            console.log('Loading drawings for user:', name);
            const url = 'https://thi-huy-default-rtdb.firebaseio.com/users/' + name + '/drawings.json';
            
            fetch(url)
            .then(response => response.json())
            .then(data => {
                if (data) {
                    window.userDrawings = data;
                    console.log('Loaded drawings:', data);
                } else {
                    window.userDrawings = {};
                    console.log('No existing drawings found');
                }
            })
            .catch(error => {
                console.log('No drawings found or error:', error);
                window.userDrawings = {};
            });
        };

        // Load a drawing onto canvas if it exists
        window.loadDrawingToCanvas = function(level) {
            const canvasId = level === 1 ? 'drawingCanvas' : 'drawingCanvas' + level;
            const canvas = document.getElementById(canvasId);
            const ctx = canvas.getContext('2d');
            
            // Clear canvas first
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Check if we have a previous drawing for this level
            const levelKey = 'level' + level;
            if (window.userDrawings && window.userDrawings[levelKey] && window.userDrawings[levelKey].drawing) {
                console.log('Loading previous drawing for level', level);
                const img = new Image();
                img.onload = function() {
                    ctx.drawImage(img, 0, 0);
                };
                img.src = window.userDrawings[levelKey].drawing;
            }
        };

        // Simple function to save drawing using REST API
        window.saveDrawingToFirebase = function(level) {
            console.log('saveDrawingToFirebase called, level:', level, 'userName:', window.userName);
            
            if (!window.userName) {
                alert('Please enter a name first');
                return;
            }
            
            const canvasId = level === 1 ? 'drawingCanvas' : 'drawingCanvas' + level;
            const canvas = document.getElementById(canvasId);
            if (!canvas) {
                console.error('Canvas not found:', canvasId);
                return;
            }
            
            const imageData = canvas.toDataURL();
            const timestamp = new Date().toLocaleString();
            const path = 'users/' + window.userName + '/drawings/level' + level;
            
            // Use REST API to save to Firebase
            const url = 'https://thi-huy-default-rtdb.firebaseio.com/' + path + '.json';
            
            fetch(url, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    drawing: imageData,
                    timestamp: timestamp
                })
            })
            .then(response => {
                if (response.ok) {
                    console.log('Drawing saved successfully to', path);
                    // Update local cache
                    window.userDrawings['level' + level] = {
                        drawing: imageData,
                        timestamp: timestamp
                    };
                } else {
                    console.error('Save failed:', response.status, response.statusText);
                }
            })
            .catch(error => {
                console.error('Error saving drawing:', error);
            });
        };

        // Load and display drawing library
        window.loadLibrary = function() {
            const url = 'https://thi-huy-default-rtdb.firebaseio.com/users.json';
            
            fetch(url)
            .then(response => response.json())
            .then(data => {
                const container = document.getElementById('libraryContainer');
                container.innerHTML = '';
                
                let allDrawings = [];
                
                // Collect all drawings from all users
                for (const userName in data) {
                    const user = data[userName];
                    if (user && user.drawings) {
                        // Check for level1
                        if (user.drawings.level1 && user.drawings.level1.drawing) {
                            allDrawings.push({
                                userName: userName,
                                level: 'level1',
                                imageData: user.drawings.level1.drawing
                            });
                        }
                        // Check for level2
                        if (user.drawings.level2 && user.drawings.level2.drawing) {
                            allDrawings.push({
                                userName: userName,
                                level: 'level2',
                                imageData: user.drawings.level2.drawing
                            });
                        }
                    }
                }
                
                // Display drawings with deterministic positioning
                allDrawings.forEach((item, idx) => {
                    const width = 200;
                    const height = 150;
                    // Use grid positioning to ensure they're visible
                    const col = idx % 3;
                    const row = Math.floor(idx / 3);
                    const left = 50 + (col * 280);
                    const top = 150 + (row * 200);
                    
                    const div = document.createElement('div');
                    div.className = 'drawing-item';
                    div.style.width = width + 'px';
                    div.style.height = height + 'px';
                    div.style.left = left + 'px';
                    div.style.top = top + 'px';
                    
                    const img = document.createElement('img');
                    img.src = item.imageData;
                    
                    div.appendChild(img);
                    container.appendChild(div);
                });
                
                // Show library page
                document.getElementById('startPage').classList.add('hidden');
                document.getElementById('libraryPage').classList.remove('hidden');
            })
            .catch(error => {
                alert('Error: ' + error.message);
            });
        };

    </script>
    <script type="module" src="2DFirebase.js"></script>
    <script>
        setTimeout(function() {
            const canvas = document.getElementById('drawingCanvas');
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            let isDrawing = false;
            
            canvas.addEventListener('mousedown', function() {
                isDrawing = true;
            });
            
            canvas.addEventListener('mousemove', function(e) {
                if (!isDrawing) return;
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                
                ctx.strokeStyle = 'black';
                ctx.lineWidth = 2;
                ctx.lineTo(x, y);
                ctx.stroke();
            });
            
            canvas.addEventListener('mouseup', function() {
                isDrawing = false;
                ctx.closePath();
            });
            
            canvas.addEventListener('mousedown', function(e) {
                const rect = canvas.getBoundingClientRect();
                ctx.beginPath();
                ctx.moveTo(e.clientX - rect.left, e.clientY - rect.top);
            });
        }, 100);

        // Setup canvas2 (level 2)
        setTimeout(function() {
            const canvas2 = document.getElementById('drawingCanvas2');
            if (!canvas2) return;
            const ctx2 = canvas2.getContext('2d');
            ctx2.fillStyle = 'white';
            ctx2.fillRect(0, 0, canvas2.width, canvas2.height);
            
            let isDrawing2 = false;
            
            canvas2.addEventListener('mousedown', function() {
                isDrawing2 = true;
            });
            
            canvas2.addEventListener('mousemove', function(e) {
                if (!isDrawing2) return;
                const rect = canvas2.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                
                ctx2.strokeStyle = 'black';
                ctx2.lineWidth = 2;
                ctx2.lineTo(x, y);
                ctx2.stroke();
            });
            
            canvas2.addEventListener('mouseup', function() {
                isDrawing2 = false;
                ctx2.closePath();
            });
            
            canvas2.addEventListener('mousedown', function(e) {
                const rect = canvas2.getBoundingClientRect();
                ctx2.beginPath();
                ctx2.moveTo(e.clientX - rect.left, e.clientY - rect.top);
            });
        }, 100);

        // Setup canvas3 (level 3)
        setTimeout(function() {
            const canvas3 = document.getElementById('drawingCanvas3');
            if (!canvas3) return;
            const ctx3 = canvas3.getContext('2d');
            ctx3.fillStyle = 'white';
            ctx3.fillRect(0, 0, canvas3.width, canvas3.height);
            
            let isDrawing3 = false;
            
            canvas3.addEventListener('mousedown', function() {
                isDrawing3 = true;
            });
            
            canvas3.addEventListener('mousemove', function(e) {
                if (!isDrawing3) return;
                const rect = canvas3.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                
                ctx3.strokeStyle = 'black';
                ctx3.lineWidth = 2;
                ctx3.lineTo(x, y);
                ctx3.stroke();
            });
            
            canvas3.addEventListener('mouseup', function() {
                isDrawing3 = false;
                ctx3.closePath();
            });
            
            canvas3.addEventListener('mousedown', function(e) {
                const rect = canvas3.getBoundingClientRect();
                ctx3.beginPath();
                ctx3.moveTo(e.clientX - rect.left, e.clientY - rect.top);
            });
        }, 100);
    </script>
</body>

</html>